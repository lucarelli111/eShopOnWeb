# RUN ALL CONTAINERS FROM ROOT (folder with .sln file):
# docker-compose build
# docker-compose up
#
# RUN JUST THIS CONTAINER FROM ROOT (folder with .sln file):
# docker build --pull -t web -f src/Web/Dockerfile .
#
# BUILD IN AZURE CONTAINER REGISTRY:
# az acr build --registry <acr-name> --image eshop-web:latest --file src/Web/Dockerfile .
#
# RUN COMMAND
#  docker run --name eshopweb --rm -it -p 8080:8080 web
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src

# Copy everything
COPY . .

# Build and publish
WORKDIR /src/src/Web
RUN dotnet publish -c Release -o /app/publish

FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS runtime
WORKDIR /app

# Install curl for health checks
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

COPY --from=build /app/publish ./

# Configure for container
ENV ASPNETCORE_URLS=http://+:8080
EXPOSE 8080

RUN mkdir -p /home/site/wwwroot/datadog
RUN mkdir -p /home/LogFiles/dotnet

ADD https://github.com/DataDog/dd-trace-dotnet/releases/download/v2.51.0/datadog-dotnet-apm-2.51.0.tar.gz /tmp/datadog.tar.gz
RUN tar -xzf /tmp/datadog.tar.gz -C /home/site/wwwroot/datadog && rm /tmp/datadog.tar.gz

ENTRYPOINT ["dotnet", "Web.dll"]
